###  

## 资料

[需求文档](http://doc.5wei.com/pages/viewpage.action?pageId=58690229)





### 组件结构

```javascript
      	  comment_reply
          |			   \
          |		 	 search_bar
        tweet_window	   \
          /		|      \	store
         /		|       \
        /		|	     \
 user-panel tweet-panel  order-panel 
 	|			|			
   	|			|			 
 user-item	   / \		 
   		  tweet   coupon
```



- comment_reply 作为主容器组织组件并定义外部样式

  - search_bar 功能组件  搜索框

    - store 业务组件负责查找并选择店铺信息

  - tweet_window  业务组件，作为整个聊天窗口的业务处理容器负责提供 VUEX 数据并监控子组件的事件并处理。

    - user-panel
      - :user-list   	                 用户列表数据
      - :statis                               评价统计数据
      - @tabChange                   tab 切换事件
      - @checkFilter                   复选窗口切换事件
      - @selectUser                    用户被选中事件
      - **user-item**
        - :user-obj                   用户信息
        - :user-index               用户遍历的索引
        - @selectUser             用户选择事件


    - tweet-panel
      - selected-user                 组件选择的当前用户
      - :tweet-list                        聊天记录列表
      - :load-more-tweets        加载更多聊天记录方法 
      - :load-more-coupons     加载更多优惠券记录方法
      - :staff-map                       过往回复员工的信息映射 
      - :coupon-list                    可用优惠券列表
      - :send-msg                       发送消息方法
      - :send-coupon                 发送优惠券方法 
      - @openOrder                   打开订单的时间
      - **tweet**
        - :tweet-obj                沟通信息数据
        - :user-obj                  用户数据
        - :staff-map               回复店员的映射对象
        - @openOrder          打开订单事件
      - coupon
        - :coupon-obj            优惠券实体
        - @selectCoupon     选择优惠券事件


    - order-panel
      - :order-obj                        订单信息实体
      - :show-panel                    是否显示订单面板
      - @orderSwitch                 订单收起或展开事件



## VUEX  结构设计（comment.js）

### state

```javascript
const state = {
  users_data: {}, //保存来自服务器的查询结果
  comment_statis: {}, //评价的统计数据
  user_map: {}, //存储所有评价数据的缓存数据，通过遍历 All 列表获得，用作用户状态更新缓存使用
  selected_user: {}, // 被选中的用户对象
  active_tab:1,     //当前显示的 tab
  current_user_list: [], //当前 tab 中显示的用户列表
  tweet_list: [], //聊天消息列表
  order_obj: {}, //订单信息,
  staff_map:{}, // 缓存店员的数据信息
  coupon_list:[], // 优惠券列表 
  current_store_id:'', //当前选择的 店铺 Id
  table_obj:{}，       // 桌台信息
};
```



### actions

- 请求评价用户统计和数据   COMMENT_REPLY_LOAD_COMMS
- 获取过滤用户列表  COMMENT_REPLY_FILTER_COMM_USERS
- 获取评价信息列表 COMMENT_REPLY_LOAD_COMM_TWEETS
- 请求订单信息       COMMENT_REPLY_LOAD_ORDER
- 请求桌台信息       COMMENT_REPLY_LOAD_TABLE
- 请求优惠券信息   COMMENT_REPLY_LOAD_COUPONS
- 发送优惠券  COMMENT_REPLY_SEND_COUPONS
- 保存消息      COMMENT_REPLY_SAVE_TWEET


### mutations

- 更新用户缓存映射  COMMENT_REPLY_UPDATE_USER_MAP
- 更新评价统计数据 COMMENT_REPLY_UPDATE_COMM_STATIS
- 更新 tab所对应用户列表数据COMMENT_REPLY_UPDATE_USER_LIST_MAP
- 修改当前选中的用户    COMMENT_REPLY_UPDATE_SELECTED_USER
- 修改当前 tab 下用户列表数据       COMMENT_REPLY_UPDATE_CURRENT_USERS
- 更新列表中的用户数据    COMMENT_REPLY_UPDATE_USER_UNREAD
- 修改所激活的 tab  COMMENT_REPLY_UPDATE_ACTIVE_TAB
- 修改评价用户的统计条数  COMMENT_REPLY_UPDATE_COMM_STATIS
- 更新当前消息列表   COMMENT_REPLY_UPDATE_TWEETS
- 更新订单数据   COMMENT_REPLY_UPDATE_ORDER


- 更新店员信息  COMMENT_REPLY_UPDATE_STAFF_MAP
- 更新优惠券列表信息 COMMENT_REPLY_UPDATE_COUPON_LIST
- 更新默认店员信息 COMMENT_REPLY_SET_DEFAULT_STAFF_IN_MAP
- 更新桌台信息  COMMENT_REPLY_UPDATE_TABLE





## 后端 Node 接口

#### 获取评价统计数据 comment/statis/:store_id

`POST`

- 调用接口

  - `core.dialog.grade.getCountGroupByScore`

- 参数

  - merchant_id           商户 id
  - store_id                   店铺 id
  - start_time               起始时间
  - end_time                结束时间
  - search_key             关键词

- 返回

  - map 类型统计结果
    - key                                 1 差，2 中，3 好
    - value                              统计结果

  ​

#### 获取评价用户列表数据 comment/users/:store_id

`POST`

- 调用接口

  - `core.dialog.grade.getOrderGradesGroupByScore`

- 参数对象 Object

  - merchant_id           商户 id
  - store_id                   店铺 id
  - start_time               起始时间
  - end_time                结束时间
  - search_key             关键词

- 返回

  - map 类型统计结果
    - key                                 1 差，2 中，3 好
    - value                             用户列表 array

  ​



#### 获取用户评价记录 comment/tweets/:store_id

`POST`

- 调用接口

  - `core.dialog.tweet.getStoreTweets`

- 参数对象

  - merchant_id           商户 id
  - store_id                   店铺 id
  - page_no                  页数
  - size                          大小
  - user_id                   用户 id

- 返回

  - 聊天记录列表数组

  ​

#### 保存聊天消息 comment/tweet/:store_id

`POST`

- 调用接口

  - `core.dialog.tweet.toStoreTweet`

- 参数

  - merchant_id           商户 id
  - store_id                   店铺 id
  - staff_id                    店员 id
  - tweet_type              消息类型    默认为 2
  - event_type              事件类型    默认为 0
  - user_id                    用户 id
  - msg_type               消息类型
  - tweet                       消息内容

- 返回

  - 消息对象

  ​

#### 发送优惠券 comment/coupons/:store_id

`POST`

- 调用接口

  - `core.coupon.coupon4common.sendCoupon`

- 参数

  - merchant_id           商户 id
  - coupon_type_id     优惠券类型 id
  - staff_id                    店员 id
  - user_id                    用户 id
  - src                            来源    默认 99
  - src_id                       来源 id 默认 ""
  - notify_message      提醒消息 默认""
  - desc                         发券描述
  - store_id                   店铺 id
  - is_send_notify_message    是否发送提醒信息 默认 1
  - is_use_default             是否用作默认  默认1
  - num                         数量  默认1

- 返回

  - 优惠券对象

  ​

#### 获取订单详情 comment/order/:store_id

`POST`

- 调用接口

  - `core.i5wei.storeOrderQuery.getStoreOrderDetailById`

- 直接传参

  - merchant_id           商户 id

  - store_id                   店铺 id

  - order_id                  起始时间

    ​

- 返回

  - 订单对象



#### 获取桌台详情 comment/table/:store_id

`POST`

- 调用接口

  - `core.i5wei.storeTableRecord.getStoreTableRecordById`

- 直接传参

  - merchant_id           商户 id

  - store_id                   店铺 id

  - table_record_id      起始时间

    ​

- 返回

  - 桌台对象

  ​

#### 获取优惠券列表 comment/coupons

`GET`

- 调用接口

  - `core.coupon.coupon4app.getCouponTypeList`

- 直接传参

  - merchant_id           商户 id
  - store_id                   店铺 id 默认 0 查询所有可用的优惠券
  - coupon_type_status  优惠券类型  默认 2  可用优惠券
  - staff_id                    店员 id
  - page                        页码
  - size                          数量

- 返回

  - 优惠券对象数组

  ​

#### 获取店员的信息 comment/staff/:staff_id

`GET`

- 调用接口

  - `core.merchant.staff.getStaffByStaffIdV2`

- 直接传参

  - merchant_id           商户 id

  - staff_id                    店员 id

    ​

- 返回

  - 店员对象

  ​





## 后端 Thrift 接口

[接口文档](http://doc.5wei.com/pages/viewpage.action?pageId=59342949)



#### 查询用户订单评价总数接口

`m-dialog/order.thrift` `getCountGroupByScore`

传入参数

```java

/**
 * 订单评分查询
 */
struct OrderGradeQueryParam{
    /**
     * 商户ID
     */
    1:i32 merchantId,
    
    /**
     * 店铺ID
     */
    2:i64 storeId,
    
    /**
     * 就餐日期（yyyy-MM-dd），菜品所在日期开始时间毫秒数
     */
    3:optional i64 repastDate,  
    
    /**
     * 餐厅营业时段ID，菜品所在日期营业时段（默认当日所对应的时间段）
     */ 
    4:optional i64 timeBucketId,    
    
    /**
     * 用户ID
     */
    5:optional i64 userId,
    
    /**
     * 0=未评分、1=差、2=中、3=好
     */
    6:optional i32 score,
    
    /**
     * 订单评分回复类型
     */
    7:OrderGradeCommentType commentType,
    
    /**
     * 第几页
     */
    8:i32 pageNo,
    
    /**
     * 每页多少条
     */
    9:i32 size,
    
    /**
     * 查询的时间范围，开始时间
     */
    10:optional i64 startTime;
    
    /**
     * 查询的时间范围，结束时间
     */
    11:optional i64 endTime;
    
    12:optional string searchKey;
}
```

返回对象 Map

```java
{
  1:
  2:
  3:
}

enum OrderScoreType{
    
    /**
     * 未评分
     */
    UNKNOWN = 0,
    
    /**
     * 差
     */
    ONE = 1,
    
    /**
     * 中
     */
    TWO = 2,
    
    /**
     * 好
     */
    THREE = 3,
}
```



#### 按条件查询用户订单评价记录

`getOrderGradesGroupByScore`

##### 入参

```java
/**
 * 订单评分查询
 */
struct OrderGradeQueryParam{

    /**
     * 商户ID
     */
    1:i32 merchantId,
    
    /**
     * 店铺ID
     */
    2:i64 storeId,
    
    /**
     * 就餐日期（yyyy-MM-dd），菜品所在日期开始时间毫秒数
     */
    3:optional i64 repastDate,  
    
    /**
     * 餐厅营业时段ID，菜品所在日期营业时段（默认当日所对应的时间段）
     */ 
    4:optional i64 timeBucketId,    
    
    /**
     * 用户ID
     */
    5:optional i64 userId,
    
    /**
     * 0=未评分、1=差、2=中、3=好
     */
    6:optional i32 score,
    
    /**
     * 订单评分回复类型
     */
    7:OrderGradeCommentType commentType,
    
    /**
     * 第几页
     */
    8:i32 pageNo,
    
    /**
     * 每页多少条
     */
    9:i32 size,
    
    /**
     * 查询的时间范围，开始时间
     */
    10:optional i64 startTime;
    
    /**
     * 查询的时间范围，结束时间
     */
    11:optional i64 endTime;
    
  	/**
     * 查询的关键词
     */
    12:optional string searchKey;
}
```



##### 出参 `map<OrderScoreType, list<UserTweetDTO>>`

```java
struct UserTweetDTO {
    /**  发评价的用户ID */
    1:i64 userId,
    /**  发评价的用户姓名 */
    2:string userName,
    /**  发评价的用户头像URL */
    3:string avatar,
    /** 评价内容 */
    4:string comments,
    /** 评价时间 */
    5:i64 tweetTime,
    /** 店内回复评价时间 */
    6:i64 replyTime,
    /** 此用户发的未被读的沟通消息 */
    7:i32 unreadNum,
}
```





#### 获取用户沟通消息列表

`m-dialog/tweet.thrift` `getStoreTweets`

##### 入参

```java
/**
 * 查询沟通记录Param
 */
struct StoreTweetsQueryParam{

    /**
     * 商户ID
     */
    1:i32 merchantId,

    /**
     * 店铺ID
     */
    2:i64 storeId,

    /**
     * 用户ID
     */
    3:i64 userId,

    /**
    * 第几页
    */
 	4:i32 pageNo,
 
   /**
    * 每页多少条
    */
 	5:i32 size,
}
```

##### 出参

```java
struct StoreTweetPageDTO{
    /**
     * 总条数
     */
    1:i32 total,
    /**
     * 总共多少页
     */
    2:i32 pageNum,
    /**
     * 每页几条
     */
    3:i32 size,
    /**
     * 第几页
     */
    4:i32 pageNo,
    /**
     * 沟通记录数据
     */
    5:list<StoreTweetDTO> dataList,
}
```



#### 保存沟通消息列表

`toStoreTweet`

入参

```java
/**
 * 沟通记录Param
 */
struct StoreTweetParam{

    /**
     * 商户ID
     */
    1:i32 merchantId,

    /**
     * 店铺ID
     */
    2:i64 storeId,

    /**
     * 客户端类型
     */
    3:i32 clientType,

    /**
     * 店员ID
     */
    4:i64 staffId,

    /**
     * 沟通消息类型：0=未知，1=用户，2=店铺，3=系统事件
     */
    5:TweetType tweetType,

    /**
     * 沟通事件消息类型
     */
    6:TweetEventType eventType,
    
    /**
     * 事件来源信息
     */
    7:string eventSrc,

    /**
     * 用户ID
     */
    8:i64 userId,
    
    /**
     * 信息类型
     */
    9:TweetMsgType msgType,

    /**
     * 内容
     */
    10:string tweet,
    
}
```



```java


/**
 * 沟通事件类型
 */
enum TweetEventType{
	/**
     * 未知
     */
    UNKNOWN = 0,
    
	/**
     * 订单消费
     */
    PAY_ORDER = 1,
	
	/**
     * 购买充值卡
     */
    BUY_CARD = 2,
    
    /**
     * 评分发优惠券
     */
    GRADE_COUPON = 3,
    
    /**
     * 获发优惠券
     */
    SEND_COUPON = 4,
	
	/**
     * 店员取消订单
     */
    CANCEL_ORDER = 5,
    
    /**
     * 店员操作订单退款
     */
    REFUND_ORDER = 6,
	
}


/**
 * 信息类型
 */
enum TweetMsgType{
	/**
     * 未知
     */
    UNKNOWN = 0,
    
	/**
     * 微信
     */
    WECHAT = 1,
	
	/**
     * 短信
     */
    SMS = 2,
    
    /**
     * 邮件
     */
    EMAIL = 3,
}

```





出参

```java

/**
 * 沟通记录DTO
 */
struct StoreTweetDTO{
    /**
     * 沟通记录主键，唯一
     */
    1:i64 tweetId,
    /**
     * 商户ID
     */
    2:i32 merchantId,
    /**
     * 店铺ID
     */
    3:i64 storeId,
    /**
     * 客户端类型
     */
    4:i32 clientType,
    /**
     * 店员ID
     */
    5:i64 staffId,
    /**
     * 沟通消息类型：0=未知，1=用户，2=店铺，3=系统事件
     */
    6:i32 tweetType,
    /**
     * 沟通事件消息类型
     */
    7:i32 eventType,
    /**
     * 事件来源信息
     */
    8:string eventSrc,
    /**
     * 用户ID
     */
    9:i64 userId,
    /**
     * 信息类型：0＝未知，1=微信，2=短信，3=邮件
     */
    10:i32 msgType,
    /**
     * 内容
     */
    11:string tweet,
    /**
     * 创建时间
     */
    12:i64 createTime,
}

```



#### 查询店铺优惠券列表

`m-coupon/coupon4app.thrift`

`getCouponTypeList`

入参

```javascript

1:i32 merchantId,				// 商户Id
2:i64 storeId, 					// 传值为 0
3:coupon_struct.CouponTypeStatus statusEnum, 	//优惠券类型
4:i64 staffId, 					// 员工Id
5:i32 page, 					// ?
6:i32 size


/**
 * 优惠券状态类型
 */
enum CouponTypeStatus {
    /**
     * 全部类型
     */
    ALL=1,
    /**
     * 可用
     */
    AVAILABLE=2,
    /**
     * 过期
     */
    OVERDUE=3
}


/**
 * 优惠券类别DTO
 */
struct CouponTypeDTO{
    /**
     * 优惠券类别id
     */
    1:i64 couponTypeId,
    /**
     * 优惠券名称
     */
    2:string couponTypeName,
    /**
     * 商编
     */
    3:i32 merchantId,
    /**
     * 优惠券级别（1：超管可发放，2：超管&店长可发放，3：谁都可以发）
     */
    4:i32 couponLevel,
    /**
     * 是否为系统锁定（1：系统锁定不允许前端修改，2：非系统锁定）
     */
    5:i32 systemLock,
    /**
     * 创建人员工id
     */
    6:i64 staffId,
    /**
     * 折扣类型
     */
    7:i32 discountType,
    /**
     * 折扣金额
     */
    8:i64 discountAmount,
    /**
     * 折扣比例
     */
    9:double discountProp,
    /**
     * 最大低佣金额
     */
    10:i64 maxAmount,
    /**
     * 最低使用金额
     */
    11:i64 leastAmount,
    /**
     * 有效期类型
     */
    12:i32 validityTimeType,
    /**
     * 指定有效期
     */
    13:i64 validityDate,
    /**
     * 自发券起N天后失效
     */
    14:i32 extendDay,
    /**
     * 标记该券是否已经发放过（1：已发放，0：未发放）
     */
    15:i32 issend,
    /**
     * 黑白名单规则（0：不限制，1：白名单，2：黑名单）
     */
    16:i32 businessLimitType,
    /**
     * 创建时间
     */
    17:i64 createTime,
    /**
     * 更新时间
     */
    18:i64 updateTime,
    /**
     * 业务来源
     */
    19:i32 src,
    /**
     * 店铺级别黑白名单限制（businessLimitType为1或2时有效）
     */
    20:list<BusinessStoreLimitDTO> businessStoreLimits,
    /**
     * 
     */
    21:i64 couponTypeVersionId,

    /**
     * 
     */
    22:i32 version,

    /**
     * 
     */
    23:i32 latestVersionFlag,

    /**
     * 当前优惠券类型累计发放的数量
     */
    24:i32 sendNum,

    /**
     * 当前优惠券类型已过期未被使用的数量
     */
    25:i32 overdueUnUsedNum,

    /**
     * 当前优惠券类型累计被使用的数量
     */
    26:i32 usedNum,

    /**
     * 当前被使用的券累计优惠的金额
     */
    27:i64 totalDisAmount,
    /**
     * 优惠券类型开始使用日期
     */
    28:i64 startTime,
    /**
     * 是否隐优惠券类型
     */
    29:bool hidden,
    /**
	 * 优惠券自发放N日开始生效,默认为0
	 */
    30:i32 startDay,
    
    /**
     * 是否堂食
     */
    31:optional bool dinein,
    
    /**
     * 是否打包、外带
     */
    32:optional bool takeout,
    
    /**
     * 是否外卖，外送
     */
    33:optional bool sendout,
    /**
     * 微信卡券Id
     */
    34:string  cardid,
    /**
     * 限制描述
     */
    35:string businessLimit,
    
}
```







#### 获取优惠券模板消息 （未使用）

`getDefaultTempByMerchantIdAndCouponTypeId`

入参

```javascript

1:i32 merchantId,			//商户 ID
2:i64 couponTypeId			//优惠券类型 ID
```

出参

```JavaScript

String 						//模板消息

```


#### 发送优惠券

`sendCoupon`

入参

```java
1:i32 merchantId, 			//商户Id
2:i64 couponTypeId, 		//优惠券Id
3:i64 operatorId, 			//发放人Id
4:i64 userId, 				//用户Id
5:i32 src, 					//?
6:string srcId, 			//?
7:string notifyMessage, 	//?
8:string desc, 
9:i64 storeId, 				//店铺Id
10:bool isSendNotifyMessage, 
11:bool isUseDefault, 		//
12:i32 num					//
  
  
  
/*src : 99
notifyMessage:""
desc:staff.name +"在沟通中发放"
isSendNotifyMessage:1
isUseDefault:1
num:发了几张券
*/
```

出参

```java
/**
 * 优惠券实体DTO
 */
struct CouponDTO{
    /**
     * 优惠券实体id
     */
    1:i64 couponId,
    /**
     * 商编
     */
    2:i32 merchantId,
    /**
     * 用户id
     */
    3:i64 userId,
    /**
     * 发券操作人员工id（系统发放为0）
     */
    4:i64 staffId,
    /**
     * 优惠券类型id
     */
    5:i64 couponTypeId,
    /**
     * 优惠券名称
     */
    6:string couponTypeName,
    /**
     * 使用状态（1：未使用，2：已使用,3：过期，4：作废，5：被用户删除）
     */
    7:i32 status,
    /**
     * 有效期
     */
    8:i64 validityTime,
    /**
     * 业务来源
     */
    9:i32 src,
    /**
     * 业务来源id
     */
    10:string srcId,
    /**
     * 创建时间
     */
    11:i64 createTime,
    /**
     * 更新时间
     */
    12:i64 updateTime,
    /**
     * 黑白名单限制
     */
    13:i32 businessLimitType,
    /**
     * 用户使用记录id（status=2时该字段有值）
     */
    14:i64 couponUserRecordId,
    /**
     * 优惠券描述（优惠券怎么得来的）
     */
    15:string desc,
    /**
     * 折扣类型
     */
    16:DiscountType discountType,
    /**
     * 低佣金额
     */
    17:i64 discountAmount,
    /**
     * 折扣比例
     */
    18:double discountProp,
    /**
     * 
     */
    19:i32 version,
    /**
     * 
     */
    20:i64 couponTypeVersionId,
    /**
     *  优惠券启用时间
     */
    21:i64 startTime,
}
```



#### 查询订单详情接口

`m-5wei/order.thrift `

`getStoreOrderDetailById`

入参

```javascript

1:i32 merchantId, 			//商户Id
2:i64 storeId, 				//店铺Id
3:string orderId			//订单Id
```

出参

```java

/**
 * 店铺订单
 */
struct StoreOrderDTO{
    /**
     * 订单ID（主键，全库唯一）
     */
    1:string orderId,

    /**
     * 商户ID
     */
    2:i32 merchantId,

    /**
     * 店铺ID
     */
    3:i64 storeId,

    /**
     * 服务员工ID（用户下单时，staff_id＝0）
     */
    4:i64 staffId,

    /**
     * 下单用户（员工下单时，有对应用户时user_id不等于0，无对应用户user_id＝0）
     */
    5:i64 userId,

    /**
     * 营业时间ID
     */
    6:i64 timeBucketId,

    /**
     * 下单终端类型（需要定义客户端类型枚举类）
     */
    7:i32 clientType,

    /**
     * 下单用户终端优惠金额，一天只有一单可以优惠
     */
    8:i64 userClientCoupon,

    /**
     * 协议企业ID
     */
    9:i32 enterpriseId,

    /**
     * 协议企业折扣
     */
    10:double enterpriseRebate,

    /**
     * 协议企业折扣，订单中多少钱可以按协议企业打折，按订单详情中可以安协议企业打折的部分统计得到
     */
    11:i64 enterpriseRebateAmount,

    /**
     * 协议企业折扣打折额度
     */
    12:i64 enterpriseRebatePrice,

    /**
     * 网单折扣
     */
    13:double internetRebate,

    /**
     * 网单折扣限额，订单中多少钱可以按网单打折，按订单详情中可以安网单打折的部分统计得到
     */
    14:i64 internetRebateAmount,
    
    /**
     * 网单打折额度
     */
    15:i64 internetRebatePrice,

    /**
     * 整单折扣比例，可能是活动或者优惠，由店铺单独设置
     */
    16:double totalRebate,

    /**
     * 整单减免金额，可能是活动或者优惠，由店铺单独设置
     */
    17:i64 totalDerate,

    /**
     * 下单币种
     */
    18:i32 orderCurrencyId,

    /**
     * 原价（含订单项目金额原价+打包费+台位费...等，不含外送费）
     */
    19:i64 orderPrice,

    /**
     * 总价（可以参与整单折扣的金额）
     */
    20:i64 totalPrice,

    /**
     * 折后价（享受完各种折扣之后的金额，不含外送费）
     */
    21:i64 favorablePrice, 
     
    /**
     * 应付，payablePrice=favorablePrice+deliveryFee
     */ 
    22:i64 payablePrice,
    
    /**
     * 支付订单ID
     */
    23:string payOrderId,

    /**
     * 实际支付币种
     */
    24:i32 actualCurrencyId,

    /**
     * 实付，实际支付币种对应的金额
     */
    25:i64 actualPrice,

    /**
     * 订单的支付状态：1=待支付；2=支付中；3=支付完成
     */
    26:i32 payStatus,

    /**
     * 1＝未退款，2＝用户全额退款：用户在支付完成之后，尚未发生实质交易时，发生的退款记录；3=商户全额退款：可能已发生交易，但由于异常情况需要做退款
     */
    27:i32 refundStatus,

    /**
     * 是否#bool订单锁定：0=未锁定、1=已锁定；例如，大额订单退款锁定
     */
    28:bool orderLocked,

    /**
     * 交易状态是对基础交易订单的交易状态进行扩展：1＝尚未交易；2＝已备货【订单已收到，并备货，用户不可以随意退款，一般用于大额订单】；3＝已开始加工【外送接单进入加工环节，不可自主退款】；4＝已送出【专用于外卖，表示餐已送出】；5＝已取号【堂食、外带时，用户已经取了小票】；6＝交易完成【已取餐，或者已经送达】
     */
    29:i32 tradeStatus,

    /**
     * 开发票的状态：1＝不开发票；2＝有发票需求，尚未开发票；3＝已开发票
     */
    30:i32 invoiceStatus,

    /**
     * 发票需求：如果订单有发票需求，需要设置发票需求信息，发票需求信息的数据格式参考“订单发票需求”
     */
    31:string invoiceDemand,

    /**
     * 取餐流水号
     */
    32:i32 takeSerialNumber,

    /**
     * 取餐验证码
     */
    33:string takeCode,

    /**
     * 取餐模式，订单的取餐模式：1＝堂食；2＝外带；3＝堂食+外带；4＝外送
     */
    34:i32 takeMode,
    
    /**
     * 取餐终端类型（需要定义客户端类型枚举类）
     */
    35:i32 takeClientType,

    /**
     * 库存保留状态，库存保留是在下单到支付期间的一段时间内，是否给用户保留库存：1＝无保留；2＝保留；3＝已扣减【支付成功，要正式扣减库存】
     */
    36:i32 takeupStatus,

    /**
     * 就餐日期，即菜单所在日期开始时间毫秒数
     */
    37:i64 repastDate,

    /**
     * 更新时间
     */
    38:i64 updateTime,

    /**
     * 新增时间
     */
    39:i64 createTime,
    
    /**
     * 订单子项目列表
     */
    40:optional list<StoreOrderItemDTO> storeOrderItemDTOs,
    
    /**
     * 店铺名称
     */
    41:optional string storeName,
    
    /**
     * 营业时段
     */
    42:optional menu_dto.StoreTimeBucketDTO storeTimeBucketDTO,
    
    /**
     * 订单操作日志
     */
    43:optional list<StoreOrderOptlogDTO> storeOrderOptlogDTOs,
    
    /**
     * 订单支付信息
     * cash_received_amount,现金收款金额
     * cash_amount, 现金支付金额
     * coupon_amount, 优惠券抵扣金额
     * prepaid_card_amount, 充值卡支付金额
     * user_account_amount, 火付账户支付金额
     * alipay_amount, 支付宝金额
     * wechat_amount, 微信支付金额
     * ipos_amount, 智能pos支付金额
     * yjpay_amount, 一键支付金额
     * pos_amount, 普通pos支付金额
     * public_transfer_amount, 对公转账支付金额
     * dynamic_pay_method_id, 自定义支付方式ID
     * dynamic_pay_method_name, 自定义支付名称
     * dynamic_pay_amount, 自定义支付金额
     * dynamic_pay_actual_amount, 自定义支付实际金额
     * dynamic_pay_type, 自定义支付券类型
     * ====微信支付信息====
     * prepay_id, 微信的预支付id
     * app_id, 公众帐号id
     * timestamp,时间戳
     * nonce_str, 随机字符串
     * sign_type, 签名类型
     * sign,签名
     */
    44:optional map<string,string> orderPayInfo,
    
    /**
     * 订单退款信息
     * amount_refund, 订单退款总金额
     * cash_refund, 现金退款
     * user_account_refund, 火付账户退款
     * prepaid_card_refund, 预付费卡退款
     * alipay_refund, 支付宝退款
     * wechat_refund, 微信支付退款
     * yj_refund,一键支付退款
     * ipos_refund,智能pos退款
     * coupon_refund, 优惠券退款
     * voucher_amount, 券面额
     * voucher_face_value, 券实际购买金额
     * voucher_refund, 券退款
     * voucher_name, 券名称
     * ====refundStoreOrderMode====
     * refund_record_id, 退款记录ID
     * refund_amount, 本次退款金额
     */
    45:optional map<string,string> orderRefundInfo,
    
    /**
     * 用户余额信息
     * prepaid_card_balance, 充值卡余额
     * user_account_balance, 火付账户余额
     * currency_id, 币种
     * coupon_type_id, 优惠券类型ID
     * coupon_type_name, 优惠券类型名称
     * coupon_discount_amount, 优惠券类型抵扣金额
     */
    46:optional map<string,string> userRemainInfo,
    
    /**
     * 外送费
     */
    47:i64 deliveryFee,
    
    /**
     * 外送相关参数
     */
    48:optional StoreOrderDeliveryDTO storeOrderDeliveryDTO,
    
    /**
     * 下单时间
     */
    49:optional i64 placeOrderTime,
    
    /**
     * 付款时间
     */
    50:optional i64 payOrderTime,
    
    /**
     * 退款时间
     */
    51:optional i64 refundOrderTime,
    
    /**
     * 取号时间
     */
    52:optional i64 takeSerialTime,
    
    /**
     * 出餐时间
     */
    53:optional i64 mealCheckoutTime,
    
    /**
     * 交易完成时间
     */
    54:optional i64 tradeFinishTime,
    
    /**
     * 是否限制取餐时间
     */
    55:optional bool limitMealTime,
    
    /**
     * 赊销状态：0=未赊账；1＝未销账；2＝销账成功；3＝赊账撤销
     */
    56:i32 creditStatus,
    
    /**
     * 赊账类型：0=未知，1＝协议企业，2＝公关费用
     */
    57:i32 creditType,
    
    /**
     * 餐牌号，为0则表示没有餐牌号
     */
    58:i32 siteNumber,
    
    /**
     * 打包费（订单项目的打包费总和）
     */
    59:i64 packageFee,
    
    /**
     * 是否会产生打包费
     */
    60:bool producePackageFee,
    
    /**
     * 交易订单变更表
     */
    61:optional StoreOrderSwitchDTO storeOrderSwitchDTO,
    
    /**
     * 折扣类型：1=企业折扣，2=网单折扣，3=整单折扣
     */
    62:i32 rebateType,
    
    /**
     * 订单备注
     */
    63:string orderRemark,
    
    /**
     * 整单折扣打折额度
     */
    64:i64 totalRebatePrice,
    
    /**
     * 订单可使用优惠券金额
     */
    65:i64 orderCouponPrice,    
    
    /**
     * 是否为补录：0=不是，1=是
     */
    66:bool backOrder,
    
    /**
     * 是否跳过取号环节：0=不是，1=是
     */
    67:bool skipTakeCode,
    
    /**
     * 是否手动设置了入客数：0=不是，1=是
     */
    68:bool enableManualCustomerTraffic,
    
    /**
     * 订单的入客数
     */
    69:i32 customerTraffic,
    
    /**
     * 是否加菜：0=不是，1=是
     */
    70:bool enableAddDishes,
    
    /**
     * 台位费
     */
    71:i64 tableFee,

    /**
     * 会员价总共优惠
     */
    72:i64 memberRebatePrice,

    /**
     * 用户点餐备注
     */
    73:string userRemark,
    
    /**
     * 此订单是否后付费：0=否，1=是
     */
    74:bool payAfter,
    
    /**
     * 桌台记录ID
     */
    75:optional i64 tableRecordId,
    
    /**
     * 父订单id
     */
    76:optional string parentOrderId,
    
    /**
     * 桌台记录信息
     */
    77:optional StoreOrderTableRecordDTO storeOrderTableRecordDTO,

    /**
     * 自助下单用户
     */
    78:i5wei_share_dto.I5weiUserDTO userDTO,

    /**
     * 下单服务员
     */
    79:i5wei_share_dto.StoreTableStaffDTO staffDTO,
    
    /**
     * 订单实际支付信息
     */
    80:optional StoreOrderActualPayDTO storeOrderActualPayDTO,
    
    /**
     * 退菜详情
     */
    81:optional list<StoreOrderRefundItemDTO> storeOrderRefundItemDTOs,
    
    /**
     * 发票信息
     */
    82:optional order_invoice_dto.StoreOrderInvoiceDTO storeOrderInvoiceDTO,
    
    /**
     * 单品折扣总共优惠
     */
    83:i64 promotionPrice,
    
    /**
     * 组合任务:买充值卡的信息
     */
    84:optional BuyPrepaidCardInfoDTO buyPrepaidCardInfoDTO,
    
	/**
     * 锁定状态：0=未锁定，1=手动锁定，2=自动锁定
     */
    85:i32 orderLockStatus,
    
    /**
     * 订单自动锁定时间
     */
    86:i64 autoLockTime,
    
    /**
     * 定时取时间
     */
    87:i64 timingTakeTime,
    
    /**
     * 定时取结束时间
     */
    88:optional i64 timingTakeEndTime,
    
    /**
     * 堂食次数
     */
    89:i32 ordersDineIn,
    
    /**
     * 打包自取次数（含快取）
     */
    90:i32 ordersTakeOut,
    
    /**
     * 堂食+打包次数
     */
    91:i32 ordersInAndOut,
    
    /**
     * 外卖次数（仅考虑通过公众号购买）
     */
    92:i32 ordersSendOut,
    
    /**
     * 所有已消费次数（即：堂食+打包+外卖次数）
     */
    93:i32 ordersTrade,

    /**
     * 协议企业折扣类型
     */
    94:i32 enterpriseRebateType,

    /**
     * 起菜状态 @StoreSendTypeEnum
     */
    95:i32 sendType,
    
    /**
     * 起菜时间
     */
    96:i64 sendTime,
	
	/**
     * 折扣活动参与的金额
     */
    97:i64 promotionRebateAmount,
    
    /**
     * 折扣活动减免金额
     */
    98:i64 promotionRebatePrice,
    
    /**
     * 满减活动ID
     */
    99:i64 promotionReduceId,
    
    /**
     * 满减活动最低消费金额
     */
    100:i64 promotionReduceQuota,
    
    /**
     * 满减活动参与的金额
     */
    101:i64 promotionReduceAmount,
    
    /**
     * 满减活动减免金额
     */
    102:i64 promotionReducePrice,
    
    /**
     * 赠菜免单金额
     */
    103:i64 gratisPrice,
    
    /**
     * 订单优惠券减免金额
     */
    104:i64 orderCouponDerate,
    
    /**
     * 订单促销信息列表
     */
    105:optional list<StoreOrderPromotionDTO> storeOrderPromotionDTOs,
    
    /**
     * 满减活动标题
     */
    106:optional string promotionReduceTitle,

     /**
     * 外卖类型
     * 0=公众号，1=美团，2=饿了么，3=百度
     */
    107:i32 waimaiType,

    /**
    * 自提点相关信息
    **/
    108:optional store_pickup_site_dto.StorePickupSiteBaseDTO storePickupSite,

    /**
    * 设备ID
    **/
    109:optional i32 appId,
    /**
     * 赠菜详情
     */
    110:optional list<StoreOrderGiftItemDTO> storeOrderGiftItemDTOs,
}
```



#### 查询桌台详情接口

`m-5wei/table_record.thrift `

`getStoreTableRecordById`

入参

```javascript
1:i32 merchantId, 			//商户 Id
2:i64 storeId, 				//店铺 Id
3:i64 tableRecordId			//桌台 Id
```

出参

```java
/**
 * 桌台记录
 */
struct StoreTableRecordDTO{
    
    /**
     * 桌台记录ID（主键全库唯一）
     */
    1:i64 tableRecordId,

    /**
     * 商编
     */
    2:i32 merchantId,

    /**
     * 店铺id
     */
    3:i64 storeId,

    /**
     * 所在桌台
     */
    4:i64 tableId,

    /**
     * 就餐日期
     */
    5:i64 repastDate,

    /**
     * 营业时段ID
     */
    6:i64 timeBucketId,

    /**
     * 主订单id
     */
    7:string orderId,

    /**
     * 拼桌序号
     */
    8:i32 tableRecordSeq,

    /**
     * 开台时间
     */
    9:i64 tableRecordTime,

    /**
     * 桌台记录状态:0=等待点餐,1=等待上菜,2=上菜中,3=菜上齐,4=已结账,5=已清台
     */
    10:i32 tableRecordStatus,

    /**
     * 付款状态:0=未付,1=部分支付,2=全额支付(付清),3=有退款
     */
    11:i32 payStatus,

    /**
     * 就餐人数
     */
    12:i32 customerTraffic,

    /**
     * 默认桌台服务员
     */
    13:i64 staffId,

    /**
     * 开台服务员
     */
    14:i64 createTableStaffId,

    /**
     * 结账服务员
     */
    15:i64 settleStaffId,

    /**
     * 清台服务员
     */
    16:i64 clearTableStaffId,

    /**
     * 开台用户id
     */
    17:i64 createTableUserId,

    /**
     * 结账用户id
     */
    18:i64 settleUserId,

    /**
     * 点餐开始时间
     */
    19:i64 orderTime,

    /**
     * 首次上菜时间
     */
    20:i64 firstUpTime,

    /**
     * 菜上齐时间
     */
    21:i64 lastUpTime,

    /**
     * 清台时间
     */
    22:i64 clearTableTime,

    /**
     * 合台目标开台记录ID
     */
    23:i64 mergeTableRecordId,

    /**
     * 合台时间
     */
    24:i64 mergeTableTime,

    /**
     * 桌台记录创建时间
     */
    25:i64 createTime,

    /**
     * 更新时间
     */
    26:i64 updateTime,

    /**
     * 区域id
     */
    27:i64 areaId,

    /**
     * 结账时间
     */
    28:i64 settleTime,

    /**
     * 桌台记录整单折扣比例
     */
    29:double discountPro,

    /**
     * 桌台记录整单减免金额
     */
    30:i64 discountAmount,

    /**
     * 桌台记录主订单的流水号
     */
    31:i32 takeSerialNumber,

    /**
     * 桌台名称
     */
    32:string tableName,

    /**
     * 区域名称
     */
    33:string areaName,

    /**
     * 合台服务员
     */
    34:i64 mergeStaffId,

    /**
     * 转台服务员
     */
    35:i64 transferStaffId,

    /**
     * 桌台原价
     */
    36:i64 tablePrice,

    /**
     * 桌台已收取台位费
     */
    37:i64 tableFee,

    /**
     * 桌台已享受折扣金额
     */
    38:i64 alreadyDiscountAmount,

    /**
     * 已退菜金额
     */
    39:i64 refundChargeItemPrice,

    /**
     * 应付金额
     */
    40:i64 payAbleAmount,

    /**
     * 已付金额
     */
    41:i64 paidAmount,

    /**
     * 以退款金额
     */
    42:i64 refundAmount,

    /**
     * 待出餐数量
     */
    43:i32 mealTakeupNum,

    /**
     * 已出餐数量
     */
    44:i32 mealCheckoutNum,

   /**
     * 区域
     */
    45:table_dto.StoreAreaDTO storeAreaDTO,

    /**
     * 桌台
     */
    46:table_dto.StoreTableDTO storeTableDTO,

    /**
     * 主订单
     */
    47:order_dto.StoreOrderDTO masterStoreOrderDTO,

    /**
     * 子订单列表
     */
    48:list<order_dto.StoreOrderDTO> subStoreOrderDTOList,

    /**
     * 退菜列表
     */
    49:list<StoreTableRecordRefundDTO> storeTableRecordRefundDTOList,

    /**
     * 桌台默认服务员
     */
    50:i5wei_share_dto.StoreTableStaffDTO tableRecordStaffDTO,

    /**
     * 开台服务员
     */
    51:i5wei_share_dto.StoreTableStaffDTO createTableRecordStaffDTO,

    /**
     * 结账服务员
     */
    52:i5wei_share_dto.StoreTableStaffDTO settleTableRecordStaffDTO,

    /**
     * 清台服务员
     */
    53:i5wei_share_dto.StoreTableStaffDTO clearTableRecordStaffDTO,

    /**
     * 自助开台用户
     */
    54:i5wei_share_dto.I5weiUserDTO createTableRecordUserDTO,

    /**
     * 自助结账用户
     */
    55:i5wei_share_dto.I5weiUserDTO settleTableRecordUserDTO,

    /**
     * 营业时段
     */
    56:menu_dto.StoreTimeBucketDTO storeTimeBucketDTO,

    /**
     * 合台服务员
     */
    57:i5wei_share_dto.StoreTableStaffDTO mergeStaffDTO,

    /**
     * 转台服务员
     */
    58:i5wei_share_dto.StoreTableStaffDTO transferStaffDTO,

    /**
     * 桌台记录支付详情
     */
    59:PayDetailInfoDTO payDetailInfoDTO,

    /**
     * 桌台记录退款详情
     */
    60:RefundDetailInfoDTO refundDetailInfoDTO,

    /**
     * 结账单
     */
    61:SettleTableRecordDTO settleTableRecordDTO,

    /**
     * 菜是否已上齐
     */
    62:bool allTakeOut,

    /**
     * 桌台记录合计退款金额（包括结账退款和订单管理退款）
     */
    63:i64 totalRefundAmount,

    /**
     * 起菜状态 1=加急 2=起菜 3=即起 （默认，即和现在取完号就上菜保持一致）4=叫起
     */
    64:i32 sendType,

    /**
     * 抹零金额
     */
    65:i64 staffDerate,

    /**
     * 减免的台位费
     */
    66:i64 reductionTableFee,

    /**
     * 桌台记录操作日志
     */
    67:list<StoreTableRecordOptlogDTO> storeTableRecordOptlogDTOs,
    /**
     * 赠菜列表
     */
    68:list<StoreTableRecordGiftDTO> storeTableRecordGiftDTOs,

    /**
     * 按分类显示点菜明细
     */
    69:list<StoreOrderDishCatDTO> StoreDishCatDTOs,

    /**
     * 台位费单价
     */
    70:i64 unitPriceOfTableFee,
}
```







    orderPrice 订单总金额

    /**
     * 满减活动减免金额
     */
    102:i64 promotionReducePrice,
    
    /**
    * 折扣活动减免金额
    */
    98:i64 promotionRebatePrice,
    
    /**
    * 满减活动减免金额
    */
    102:i64 promotionReducePrice,
    
     /**
     * 协议企业折扣
     */
     10:double enterpriseRebate,
     
     /**
     * 网单折扣
     */
     13:double internetRebate,
    
    /**
    * 会员价总共优惠
    */
    72:i64 memberRebatePrice,
        
    /**
    * 网单折扣
    */
    13:double internetRebate,


     /**
        * 实付，实际支付币种对应的金额
        */
        25:i64 actualPrice,


赠菜

​	

```
struct StoreOrderGiftItemDTO {
1:string orderId,
2:i64 storeId,
3:i64 chargeItemId,
4:string chargeItemName,
5:i64 price,
6:double quantity,
7:string reason,
8:i64 staffId,
9:i64 createTime,
10:string unit,
}
```



订单支付信息

    /**
     * 订单支付信息
     * cash_received_amount,现金收款金额
     * cash_amount, 现金支付金额
     * coupon_amount, 优惠券抵扣金额
     * prepaid_card_amount, 充值卡支付金额
     * user_account_amount, 火付账户支付金额
     * alipay_amount, 支付宝金额
     * wechat_amount, 微信支付金额
     * ipos_amount, 智能pos支付金额
     * yjpay_amount, 一键支付金额
     * pos_amount, 普通pos支付金额
     * public_transfer_amount, 对公转账支付金额
     * dynamic_pay_method_id, 自定义支付方式ID
     * dynamic_pay_method_name, 自定义支付名称
     * dynamic_pay_amount, 自定义支付金额
     * dynamic_pay_actual_amount, 自定义支付实际金额
     * dynamic_pay_type, 自定义支付券类型
     * ====微信支付信息====
     * prepay_id, 微信的预支付id
     * app_id, 公众帐号id
     * timestamp,时间戳
     * nonce_str, 随机字符串
     * sign_type, 签名类型
     * sign,签名
     */
    44:optional map<string,string> orderPayInfo,



```
/**
 * 订单促销活动信息 
 */
struct StoreOrderPromotionDTO{
	
	/**
     * 订单ID（主键，全库唯一）
     */
    1:string orderId,

    /**
     * 商户ID
     */
    2:i32 merchantId,

    /**
     * 店铺ID
     */
    3:i64 storeId,
    
    /**
     * 活动ID
     */
    4:i64 promotionId,
    
    /**
     * 活动类型
     */
    5:i32 promotionType,
	
	/**
     * 活动标题
     */
    6:string promotionTitle,
	
	/**
     * 活动减免金额
     */
    7:i64 promotionDerate,
}
```



```
/**
 * 桌台记录
 */
struct StoreOrderTableRecordDTO{
    /**
     * 桌台记录ID（主键全库唯一）
     */
    1:i64 tableRecordId,

    /**
     * 所在桌台
     */
    2:i64 tableId,

    /**
     * 区域id
     */
    3:i64 areaId,

    /**
     * 桌台名称
     */
    4:string tableName,

    /**
     * 区域名称
     */
    5:string areaName,

    /**
     * 主订单id
     */
    6:string orderId,

    /**
     * 拼桌序号
     */
    7:i32 tableRecordSeq,

    /**
     * 开台时间
     */
    8:i64 tableRecordTime,

    /**
     * 桌台记录状态
     */
    9:i32 tableRecordStatus,

    /**
     * 付款状态
     */
    10:i32 payStatus,

    /**
     * 是否上过菜：0=没上过菜，1=上过菜
     */
    11:i32 meal,

    /**
     * 就餐人数
     */
    12:i32 customerTraffic,

    /**
     * 桌台服务员
     */
    13:i64 staffId,

    /**
     * 桌台服务员用户id
     */
    14:i64 staffUserId,

    /**
     * 用户id
     */
    15:i64 userId,

    /**
     * 起菜状态
     */
    16:i32 sendType,
}

```



优惠核对



企业折扣：享受企业折扣的总单数和金额；√
网单优惠：享受自助下单折扣的总单数和金额 √
公关招待：享受公关招待的订单数及金额 X
折扣和减免：通过收银员直接折扣或者减免的金额 √
会员优惠：享受会员价带来折扣的订单数及金额；√
首份特价：享受首份特价产生的优惠； ?
自定义收单方式优惠：自定义收单方式的收款金额和实际收款金额的差额产生的优惠，label 为支付方式后边+优惠两个字  √  支付信息
如：美团团购，收款100，实际收款80，店铺优惠中列出：美团团购优惠：20元，XX笔；
折扣活动 ?
台位费减免   
赠菜





StoreOrderActualPayDTO  支付相关



```java
Map<String, Object> map = new HashMap<String, Object>();
  StoreOrderActualPayDTO storeOrderActualPayDTO = storeOrderDTO.getStoreOrderActualPayDTO();
  if (storeOrderActualPayDTO == null) {
   return map;
  }
        map.put("order_price", storeOrderActualPayDTO.getOrderPrice());
  map.put("charge_item_price", storeOrderActualPayDTO.getChargeItemPrice());
        map.put("actual_price", storeOrderActualPayDTO.getActualPrice());
        map.put("delivery_fee", storeOrderActualPayDTO.getDeliveryFee());
        map.put("table_fee", storeOrderActualPayDTO.getTableFee());
        map.put("favourable_derate", storeOrderActualPayDTO.getFavourableDerate());
        map.put("internet_rebate_price", storeOrderActualPayDTO.getInternetRebatePrice());
        map.put("enterprise_rebate_price", storeOrderActualPayDTO.getEnterpriseRebatePrice());
        map.put("member_rebate_price", storeOrderActualPayDTO.getMemberRebatePrice());
        map.put("promotion_price",storeOrderActualPayDTO.getPromotionPrice());
        map.put("promotion_rebate_price", storeOrderActualPayDTO.getPromotionRebatePrice());
        map.put("promotion_reduce_price", storeOrderActualPayDTO.getPromotionReducePrice());
        map.put("gratis_price", storeOrderActualPayDTO.getGratisPrice());
        map.put("coupon_amount", storeOrderActualPayDTO.getCouponAmount());
        map.put("dynamic_pay_method_name", storeOrderActualPayDTO.getDynamicPayMethodName() + "");
        map.put("dynamic_pay_derate", storeOrderActualPayDTO.getDynamicPayDerate());
        map.put("cash_received_amount", storeOrderActualPayDTO.getCashReceivedAmount());
        map.put("cash_amount", storeOrderActualPayDTO.getCashAmount());
        map.put("cash_return_amount", storeOrderActualPayDTO.getCashReturnAmount());
        map.put("pay_result_of_dynamic", buildStoreOrderPayResultOfDynamic(storeOrderActualPayDTO.getStoreOrderPayResultOfDynamicPayMethods()));
        map.put("total_derate", storeOrderActualPayDTO.getTotalDerate());
        map.put("total_derate2", storeOrderActualPayDTO.getTotalDerate2());
        map.put("total_rebate_price_v2", storeOrderActualPayDTO.getTotalDerate() - storeOrderDTO.getTotalDerate());
        map.put("total_derate_v2", storeOrderDTO.getTotalDerate());
```



### 订单 example

```

{ order_id: '1337283570064082824',
  merchant_id: 26,
  store_id: 64,
  staff_id: 0,
  user_id: 1101766,
  time_bucket_id: 1094,
  client_type: 5, // 怎么下的单 终端
  user_client_coupon: 0,  
  enterprise_id: 0,
  enterprise_rebate: 65,
  enterprise_rebate_amount: 0,
  enterprise_rebate_price: 0,
  internet_rebate: 90,
  internet_rebate_amount: 0,
  internet_rebate_price: 0,
  total_rebate: 100,
  total_derate: 0,
  order_currency_id: 1,
  order_price: 9800,  // 原价
  total_price: 9800,  // ?
  favorable_price: 9800, // 折后金额 （去掉折扣）
  payable_price: 9800,    // 应付
  pay_order_id: '133728360705066605',
  actual_currency_id: 1,
  actual_price: 9800,
  pay_status: 3,
  refund_status: 1,
  order_locked: true,
  trade_status: 6,
  invoice_status: 1,
  invoice_demand: '',
  take_serial_number: 10026,
  take_code: '226910',
  take_mode: 4,  // 取餐方式   
  take_client_type: 1,
  takeup_status: 3,
  repast_date: 1490630400000,
  update_time: 1490922604734,
  create_time: 1490697957351,  // 下单时间 
  store_order_item_dtos:  //明细
  [ { tid: 55960,
       order_id: '1337283570064082824',
       merchant_id: 26,
       store_id: 64,
       charge_item_id: 3156,
       charge_item_name: 'xtao75324168',
       rebate_able: false,
       amount: 1,
       unit: '份',
       price: 9800, //单价
       packed_amount: 1,
       update_time: 1490699040329,
       create_time: 1490697957367,
       store_order_sub_item_dtos: [Object],
       package_price: 0, // 打包费
       spicy_level: 0,
       coupon_supported: true,
       enable_customer_traffic: false,
       member_price: 0,
       refund_charge_item_num_packed: 0,
       refund_charge_item_num_un_packed: 0,
       gratis_amount: 0,
       gratis_derate: 0,
       member_derate: 0,
       internet_derate: 0,
       enterprise_derate: 0,
       promotion_item_derate: 0,
       promotion_rebate_derate: 0,
       promotion_reduce_derate: 0,
       staff_rebate_derate: 0,
       coupon_derate: 0,
       charge_item_derate: 0,
       store_order_sub_item_size: 1,
       same_sub_item_name: false,
       weight_enabled: false,
       gift_charge_item_num_packed: 0,
       gift_charge_item_num_un_packed: 0 } ],
  store_name: null,
  store_time_bucket_dto:
  { time_bucket_id: 1094,
     merchant_id: 26,
     store_id: 64,
     start_time: 0,
     end_time: 64500000,
     name: 'by',  //  营业时段 名称
     create_time: 1482822471897,
     update_time: 1493953969237,
     deleted: false,
     in_biz_time: false,
     delivery_supported: true,
     delivery_start_time: 0,
     delivery_end_time: 86100000,
     delivery_start_time_for_biz: 0,
     delivery_end_time_for_biz: 64500000,
     table_fee: 500,  
     tips: '' },
  store_order_optlog_dtos: null,
  order_pay_info: null,
  order_refund_info: null,
  user_remain_info: null,
  delivery_fee: 0,
  store_order_delivery_dto:
   { order_id: '1337283570064082824',
     merchant_id: 26,
     store_id: 64,
     contact_name: '哈哈',
     contact_phone: '15106938888',
     delivery_staff_id: 1000679,
     delivery_staff_user_id: 1101661,
     delivery_finish_time: 1490922604876,
     delivery_start_time: 1490872534358,
     delivery_assign_time: 1490698560422,
     delivery_building_id: 45,
     delivery_building_name: '万通',
     delivery_building_address: '朝外大街甲六号👌',
     user_address: '回来了',
     delivery_status: 5,
     store_shipping: true,
     waimai_order_id: '',
     waimai_type: 0,
     waimai_day_seq: 0,
     waimai_pay_type: 0,
     waimai_first_order: false,
     waimai_favorites: false,
     shipper_phone: '',
     latitude: 0,
     longitude: 0,
     waimai_refund_type: 0,
     waimai_delivery_time: 0,
     poi_money_cent: 0,
     mt_money_cent: 0,
     box_price: 0,
     delay_receive_order_minute: 0,
     receive_order_type: 0,
     remarks: '',
     store_pickup_site_id: 0,
     store_pickup_name: '' },
     place_order_time: 1490697957377,
  pay_order_time: 1490697961587,
  refund_order_time: 0,
  take_serial_time: 1490699040448,
  meal_checkout_time: 1490699040400,
  trade_finish_time: 1490922604878,
  limit_meal_time: true,
  credit_status: 0,
  credit_type: 0,
  site_number: 0,
  package_fee: 0,  // 总的打包费
  produce_package_fee: false,
  store_order_switch_dto: null,
  rebate_type: 0,
  order_remark: '',
  total_rebate_price: 0,
  order_coupon_price: 9800,
  back_order: false,
  skip_take_code: false,
  enable_manual_customer_traffic: false,
  customer_traffic: 0,
  enable_add_dishes: false,
  table_fee: 0,
  member_rebate_price: 0,
  user_remark: '',
  pay_after: false,
  table_record_id: 0,
  parent_order_id: '',
  store_order_table_record_dto: null,
  user_dto:
   { user_id: 1101766,
     name: '落',
     mobile: '',
     head: 'http://wx.qlogo.cn/mmopen/pPEzcNMQFWd9UKWoxjVNu7hDnptSc2aJ3ZcybonsdT8jr59mppnMqhic2Kr9eQtFIaVJA8czTFCV8qj7ibpeosnB0Za05gnAxv/0',
     sex: 0,
     id_card: null },
  staff_dto: null,
  store_order_actual_pay_dto: null,
  store_order_refund_item_dtos: null,
  store_order_invoice_dto: null,
  promotion_price: 0,
  buy_prepaid_card_info_dto: null,
  order_lock_status: 2,
  auto_lock_time: 1490701561632,
  timing_take_time: 0,
  timing_take_end_time: 0,
  orders_dine_in: 3,
  orders_take_out: 1,
  orders_in_and_out: 0,
  orders_send_out: 2,
  orders_trade: 6,
  enterprise_rebate_type: 1,
  send_type: 3,
  send_time: 0,
  promotion_rebate_amount: 0,
  promotion_rebate_price: 0,
  promotion_reduce_id: 0,
  promotion_reduce_quota: 0,
  promotion_reduce_amount: 0,
  promotion_reduce_price: 0,
  gratis_price: 0,
  order_coupon_derate: 0,  
  store_order_promotion_dtos: null,
  promotion_reduce_title: '',
  waimai_type: 0,
  store_pickup_site: null,
  app_id: 0,
  store_order_gift_item_dtos: null }



```



[配置菜单权限](http://doc.5wei.com/pages/viewpage.action?pageId=18808848#id-02火付云餐饮OS-权限设置-五味管家)

